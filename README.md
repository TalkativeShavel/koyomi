# koyomi

# はじめに

日本の暦に基づいて様々計算を行うクラスです  

主な機能

  + フォーマット
  + 日にち、時間等の加算
  + 営業日の加算・日数計算
  + 祝日一覧の取得
  + カレンダーデータの取得

# 和暦

日本の暦では、年号を使用した日付の表記(和暦)がよく使用されます  
和暦は年区切りと日付区切りの両方をサポートしています

| 年号 | 年区切りの期間 | 日付区切りの期間      |
|------|--------------- |-----------------------|
| 平成 | 1989年-        | 1989/01/08-           |
| 昭和 | 1926年-1988年  | 1926/12/25-1989/01/07 |
| 大正 | 1912年-1925年  | 1912/07/30-1926/12/24 |
| 明治 | 1868年-1911年  | 1868/01/25-1912/07/29 |

(注意)  
1868年から明治ですが、グレゴリオ歴の導入は1873年（明治6年）以降のため、それ以前は和暦は旧暦のこよみになります。  
そのため、1872年以前で和暦の変換を行うと西暦表示になります

# 祝日

Koyomiに設定されている祝日は、1948年7月20日に施行された祝日法に基づき計算されています  
祝日データは2015年5月時点で決定されているものが反映されています  
（2016年から新しく施行される山の日まで)

祝日を得ることは、フォーマットとは別に行いたい場合があるかもしれせん  
ある年の祝日の一覧を取得したい場合は次のようにします

```
var holidays = Koyomi.getHolidays(2015);
```


# インスタンスの作成

インスタンスを作成することで、多くの機能を使用することができます

```
var koyomi = new Koyomi();
```

インスタンスには次のプロパティと既定値が設定されています

## プロパティ

### フォーマット

フォーマットの既定値は`'Y-m-d H:i:s'`です  
この値を変更した場合は、formatメソッドで第二引数を指定しなかった場合に既定値が使用されます

設定方法

```
koyomi.defaultFormat = 'Y年n月j日 G時i2分s2秒';
```

文字のエスケープはphpのdate関数と異なり、`{}`を使用します  
一箇所でも`{}`が含まれているとエスケープが有効になります  
`{}`で囲った部分をパラメータ文字列と認識し
その他の文字はすべてそのまま表示されるようになります

```
koyomi.defaultFromat = '{Y}/{m}/{d} updated';
```

### 定休日

定休日の既定値は`'土,日'`です  
曜日を指定するときには、日から土をカンマ区切りで指定します  
`'sun'`や`'Sunday'`なども設定することができます  
固定の日を指定する場合は、`'5,15,25'`のように数字をカンマ区切りでしています  
第xy曜日などの指定は`'2水,3水'`と、何週目のあとに曜日を指定します  
これらは、混合させることもできます  
上記では対応できない場合は、関数を指定することで細かな定休日を指定することができます  
引数はDateオブジェクトのみで、定休日の場合はtrueを返すようにします

設定方法

```
koyomi.regularHoliday = '日,2土,3土,30';
```

### 年末年始、お盆の休業日

定休日とは別に、年末年始・お盆の休業日を設定することができます  
既定値は、`'12/29-1/3'`です  
お盆の期間も指定する場合は、カンマ区切りで、`'12/29-1/3, 8/16-8/18'`のように指定します
単発の日付を指定する場合は、`'12/29-1/3, 10/10'`などのします  
上記では対応できない場合は、関数を指定することで細かな休業日を指定することができます  
引数はDateオブジェクトのみで、休業日の場合はtrueを返すようにします

設定方法

```
koyomi.seasonHoliday = '12/29-1/3, 8/16-8/18';
```

### 祝日の営業

祝日を営業日にするかどうかを設定することができます  
既定値は`false`(祝日は休業日)です

設定方法

```
koyomi.holidayOpened = true; // 営業日にする
```


## メソッド

### フォーマット

フォーマットとは、日時からある形式に基づいた文字列を作成することです  
指定できる形式はパラメータ文字列と呼ばれる部品を組み合わせて作成します 
パラメータ文字列はPHPの[date関数](http://php.net/manual/ja/function.date.php)をベースに拡張しています
拡張の部分では日本の年号、祝日、営業日に対応しています
 (タイムゾーン等一部のパターンは未実装です)


定義

  `{String} koyomi.format( {Date|String} date [, {String} format [, {Number} eigyobi [, {Boolean} include]]] )`  
  formatの既定値はkoyomi.defaultFormatです  
  eigyobiの既定値は設定されていません  
  includeの既定値はfalseです

例

```
koyomi.format(new Date('2015-4-27'), 'Y/m/d');  // '2015/4/27'
koyomi.format('2015-4-27', 'Y/m/d');  // '2015/4/27'
```

２つめのように日付をあらわす文字列を直接引数にしてもかまいません

次のようにすると翌営業日を対象にします

```
koyomi.format('2015-5-4', 'Y/m/d', 1);  // '2015/5/7'
```

0を設定すると、第一引数が営業日であればその日を、そうでなければ翌営業日を対象にします

includeをtrueにすると初日も営業日のカウントに含めます

```
koyomi.format('2015-5-1', 'Y/m/d', 1, true);  // '2015/5/1'
```

#### パラメータ文字列

以下の文字が format パラメータ文字列として認識されます

| 文字     | 説明                                                                | 戻り値の例       |
|----------|---------------------------------------------------------------------|------------------|
| hizuke   | 日付 `Y/m/d`を指定したのと同じ                                      | 2015/04/06       |
| wareki   | 和暦 年区切り   `nengonen年n月j日`を指定したのと同じ                | 平成1年1月7日    |
| wareki2  | 和暦 日付区切り `NengoNen年n月j日`を指定したのと同じ                | 昭和64年1月7日   |
| Y        | 年 ４桁                                                             | 2014             |
| y        | 年 下２桁                                                           | 14               |
| L        | うるう年判定  1:うるう年、0:平年                                    | 1, 0             |
| nengo    | 和暦 年区切り 年号 1872年以前は西暦                                 | 昭和, 平成       |
| nengo2   | 和暦 年区切り 年号 省略表示                                         | S, H             |
| nen      | 和暦 年区切り 年                                                    | 1, 27            |
| nen2     | 和暦 年区切り 年   1は元                                            | 元, 27           |
| nen3     | 和暦 年区切り 年   1は元 その他は漢数字                             | 元, 二十七       |
| nen4     | 和暦 年区切り 年   1は元 その他は漢数字(省略形)                     | 元, 二七         |
| Nengo    | 和暦 日付区切り 年号 1872年以前は西暦                               | 昭和, 平成       |
| Nengo2   | 和暦 日付区切り 年号 省略表示                                       | S, H             |
| Nen      | 和暦 日付区切り 年                                                  | 1, 27            |
| Nen2     | 和暦 日付区切り 年   1は元                                          | 元, 27           |
| Nen3     | 和暦 日付区切り 年   1は元 その他は漢数字                           | 元, 二十七       |
| Nen4     | 和暦 日付区切り 年   1は元 その他は漢数字(省略形)                   | 元, 二七         |
| m        | 月 0あり                                                            | 08, 12           |
| n        | 月 0なし                                                            | 8, 12            |
| F        | 月 英語                                                             | August           |
| M        | 月 英語 省略形                                                      | Aug              |
| tuki     | 月 漢数字                                                           | 八, 十二         |
| tuki2    | 月 漢数字 省略形                                                    | 八, 一二         |
| t        | 月の日数                                                            | 28, 29, 30, 31   |
| W        | 週番号   年の第何週目かを示す。始まりの月は1月、週の始まりは月曜日  | 1,2, 42, 53      |
| Wj       | 週番号   年の第何週目かを示す。始まりの月は4月、週の始まりは日曜日  | 1,2, 42, 53      |
| d        | 日 0あり                                                            | 05, 15, 25       |
| j        | 日 0なし                                                            | 5, 15, 25        |
| niti     | 日 漢数字                                                           | 五, 十五, 二十五 |
| niti2    | 日 漢数字 省略形                                                    | 五, 一五, 二五   |
| S        | 接頭語                                                              | st, nd, rd, th   |
| z        | 年通算日数  0から開始                                               | 0, 38, 364       |
| w        | 曜日 日:0 -> 土:6                                                   | 0, 6             |
| N        | 曜日 月:1 -> 日:7                                                   | 1, 7             |
| l        | 曜日 英語                                                           | Monday           |
| D        | 曜日 英語 省略形                                                    | Mon              |
| yobi     | 曜日 日本語 省略形                                                  | 月, 火, 水       |
| yobi2    | 曜日 日本語 省略形 祝日は曜日の代わりに祝                           | 月, 火, 祝       |
| yobi3    | 曜日 日本語 祝日は曜日の代わりに祝日                                | 月曜日, 祝日     |
| eigyo    | 曜日 日本語 省略形 休業日は曜日の代わりに休                         | 月, 火, 休       |
| eigyo2   | 曜日 日本語 休業日は曜日の代わりに休業日                            | 月曜日, 休業日   |
| holiday  | 祝日名 日本語 祝日でない場合は空文字                                | 元日, 成人の日   |
| holiday2 | 祝日名 日本語 holidayに加え、年末年始/お盆の休みを休業日と返す      | 元日, 休業日     |
| g        | 時 12時間制 0なし                                                   | 3, 9             |
| G        | 時 24時間制 0なし                                                   | 3, 9, 15         |
| h        | 時 12時間制 0あり                                                   | 03, 09           |
| H        | 時 24時間制 0あり                                                   | 03, 09, 15       |
| i        | 分 0あり                                                            | 03, 09           |
| i2       | 分 0なし                                                            | 3, 9             |
| s        | 秒 0あり                                                            | 03, 09, 15       |
| s2       | 秒 0なし                                                            | 3, 9, 15         |
| u        | マイクロ秒 0あり (ミリ秒までしか計測できないので下3桁は常に0になる) | 065000           |
| a        | am/pm                                                               | am, pm           |
| A        | AM/PM                                                               | AM, PM           |
| aj       | 午前/午後                                                           | 午前, 午後       |

#### 和暦での入力

和暦の入力は限定的に許可されています

  + 指定できるのは日付のみ
  + 数字は半角のみ
  + 平成,昭和,大正,明治,H,S,T,Mで始まり、年がそれに続く
  + 明治元年から5年は旧暦のため非対応(正しい結果ではありません)
  + 年、月、日の各数字の間に数字以外の文字が存在すること

この条件で入力を受け付ける例

  + 昭和50年1月2日
  + S50-1-2
  + H1 10 10

`koyomi.format('S50-1-1', 'Y/m/d') // 1975/01/01`


## 営業日の加算

日付に営業日を加算した日付の算出を行うことができます

`var eigyobi =  koyomi.addEigyobi(date, days, include)`

  + date
    + 基準となる日時です
    + DateもしくはString
    + 必須です
    + 日にちの部分は変更されます
    + 時間部分の値は変化しません
  + days
    + カウントする営業日数
    + 必須です
    + 1以上の場合は、翌営業日からカウントして算出します
    + 0の場合は、dataが営業日であればdateを、そうでない場合は翌営業日を返します
    + -1以下の場合は、さかのぼって算出します
  + include
    + trueの場合、dateもカウントの対象に含みます
    + 既定値はfalseです
    + daysが0の場合はincludeは無視されます

基準となる日時より１年先（前）以内に営業日が存在しなかった場合はnullが返されます


## 営業日から逆算

日付の営業日を加算する前の日付の算出を行うことができます  
候補はいくつか出てきますが、一番近い日付を返します

`var eigyobi = koyomi.toEigyobi(date, days, include)`

例えば次のような場面で使用します。  
3営業日で納品しなければならない。本日は、いつまでの日までの分の受注を納品作業しなければならないか？


## 営業日数の算出

フォーマット関数では使用しませんが、営業日数を数えることができる関数が定義されています  

`var count = koyomi.countEigyobi(from, to)`

  + from
    + 開始日
    + DateもしくはString
    + 必須です
  + to
    + 終了日
    + DateもしくはString
    + 必須です


# カレンダーデータの取得

カレンダーデータを簡単に作成することのできる補助関数が用意されています  

`var data = Koyomi.getCalendarData(range, startWeek, six);`

一般的なカレンダーをDOMの動的作成する際に、通常次のような処理が必要です

  1. 曜日の始まりを決め、1日より前に幾つの空マスを用意しなければならないか計算
  2. 週の終わりを検査し、次の行にするための判定を行う
  3. 末日から週の終わりまで幾つの空マスで埋めるかを計算
  4. 複数月を処理する場合は、データを何度も取得し、上記を行う

これらを複雑な処理をViewコードで行う必要はありません  

### データ

補助関数を使用すると、次のようなデータを取得することができます

```
koyomi.getCalendarData('2015/5', '日', true) ->

[
  {block: "2015/05", day: 26, eom: false, eow: false, ghost: true, holiday: "", month: 4, opened: false, som: true, sow: true, week: 0, year: 2015, weekNumber: 1},
  {block: "2015/05", day: 27, eom: false, eow: false, ghost: true, holiday: "", month: 4, opened: true, som: false, sow: false, week: 1, year: 2015, weekNumber: 1},
  {block: "2015/05", day: 28, eom: false, eow: false, ghost: true, holiday: "", month: 4, opened: true, som: false, sow: false, week: 2, year: 2015, weekNumber: 1},
  {block: "2015/05", day: 29, eom: false, eow: false, ghost: true, holiday: "昭和の日", month: 4, opened: false, som: false, sow: false, week: 3, year: 2015, weekNumber: 1},
  {block: "2015/05", day: 30, eom: false, eow: false, ghost: true, holiday: "", month: 4, opened: true, som: false, sow: false, week: 4,  year: 2015, weekNumber: 1},
  {block: "2015/05", day: 1, eom: false, eow: false, ghost: false, holiday: "", month: 5, opened: true, som: false, sow: false, week: 5, year: 2015, weekNumber: 1},
  {block: "2015/05", day: 2, eom: false, eow: true, ghost: false, holiday: "", month: 5, opened: false, som: false, sow: false, week: 6, year: 2015, weekNumber: 1},
    (中略)
  {block: "2015/05", day: 31, eom: false, eow: false, ghost: false, holiday: "", month: 5, opened: false, som: false, sow: true, week: 0, year: 2015, weekNumber: 6},
  {block: "2015/05", day: 1, eom: false, eow: false, ghost: true, holiday: "", month: 6, opened: true, som: false, sow: false, week: 1, year: 2015, weekNumber: 6},
  {block: "2015/05", day: 2, eom: false, eow: false, ghost: true, holiday: "", month: 6, opened: true, som: false, sow: false, week: 2, year: 2015, weekNumber: 6},
  {block: "2015/05", day: 3, eom: false, eow: false, ghost: true, holiday: "", month: 6, opened: true, som: false, sow: false, week: 3, year: 2015, weekNumber: 6},
  {block: "2015/05", day: 4, eom: false, eow: false, ghost: true, holiday: "", month: 6, opened: true, som: false, sow: false, week: 4, year: 2015, weekNumber: 6},
  {block: "2015/05", day: 5, eom: false, eow: false, ghost: true, holiday: "", month: 6, opened: true, som: false, sow: false, week: 5, year: 2015, weekNumber: 6},
  {block: "2015/05", day: 6, eom: true, eow: true, ghost: true, holiday: "", month: 6, opened: false, som: false, sow: false, week: 6, year: 2015, weekNumber: 6}
]
```

最初の行のデータは4/26のもので、最後の行のデータは6/6のものです  
引数で指定した月以外の日データも含まれてますが、これで正常な動作です  
この指定した月以外の日をゴースト日と呼びます  
 (カレンダーでは通常、薄いグレーなど影を薄くするためゴースト日と命名しました。造語です。)  
このデータを利用すると先の1-4は次のように行います

  1. 最初の要素から表示する。その際、ghost=trueは前月の日付なので目立たないように表示する
  2. eow=trueは週の終わりなので、次行へ
  3. 末日後もそのまま要素を表示する。その際ghost=trueは前月の日付なので目立たないように表示する
  4. 複数月の場合は、som=trueは新しい月の最初のデータ、eom=trueは月の最後のデータとして扱う

このように、カレンダーを作成するための情報が揃っています  
Viewコードではデザインだけに集中することができます

具体的なViewコードは、[example/calendar.html](https://github.com/yukik/koyomi/blob/master/example/calendar.html)を確認してください  
非常にすっきりとしたViewコードであることが確認できます  
これであれば、もっと複雑な処理（カレンダーを値の入力に使用する・予定を表示させるなど）を追加することが容易になります

### 引数の説明

  + range 
      + 期間を指定します
      + 次の３つの指定の方法があります
          + 年を指定して1月から12月まで取得    2015, '2016'など
          + 月を指定 '2015/4', '2015/10'など
          + 期間を指定 '2015/4-2016/3'など
  + startWeek
      + 開始曜日を指定します 
      + 規定値 null
      + '月', '日'や'Mon', 'sunday' など大文字小文字問わず英語も指定できます
      + 指定した場合は、ゴースト日のデータが追加され、sow/eow/ghost/blockのプロパティが追加されます
      + 指定しない場合は、範囲指定した月のデータのみが取得されます
  + six
      + 6週分までゴースト日を追加します
      + 既定値は false
      + trueにすることで、月によって行数が変わることなくデザイン上、表示スペースを固定することができます

### プロパティの説明

  + som  (start of month)
    + 月のはじめ 
  + eom  (end of month)
    + 月の終わり 
  + year
    + 年
    + この年は、取得した月の年を表すのではなく、この日オブジェクト自身の年です
    + どの月のデータとして取得したかは、blockプロパティで判定してください
  + month
    + 月
    + この年は、取得した月を表すのではなく、この日オブジェクト自身の年です
    + どの月のデータとして取得したかは、blockプロパティで判定してください
  + day
    + 日
  + week
    + 曜日 0:日->6:土
  + opened
    + 営業日ならtrue
  + holiday
    + 祝日名、祝日ではない場合はnull
  + sow (start of week)   
    + 週のはじめ 
    + 開始曜日設定時のみ
  + eow  (end of week)
    + 週の終わり
    + 開始曜日設定時のみ
  + ghost
    + ゴースト日はtrue
    + 開始曜日設定時のみ
  + block
    + 月ブロックのキー 
    + どの月のデータとして取得したかを表します
    + 年月を次のような文字列で示します '2015/01'
    + 開始曜日設定時のみ
  + weekNumber
    + 週番号

### 利点

カレンダー作成時に`getCalendarDate`を利用することは大きな利点があります

  + Viewコードがすっきりする
  + 日曜始まりから月曜始まりの修正は、ほぼ一箇所だけで簡単に済むようになる
  + 祝日名、営業中などの情報が含まれている
  + 複数の月データを簡単に処理できる
  + カレンダー以外の用途にも使用できる


